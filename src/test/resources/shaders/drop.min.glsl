uniform vec4 v[2];const vec3 i=vec3(1.,0.,0.),f=.001*i;vec4 c=v[0],l=v[1];float r=0.,a=0.,b=1.2,g=pow(2.2,float(-14));vec4 m,s=vec4(5.,-5.,l.g*5.,1.),x=vec4(2.2)/.6;mat4 n=mat4(cos(l.b),sin(l.b),0.,0.,-sin(l.b),cos(l.b),0.,0.,0.,0.,1.,0.,0.,0.,0.,1.);vec2 t(vec2 v,vec2 c,float r){float b=clamp(.5+.5*(c.r-v.r)/r,0.,1.);return mix(c,v,b)-r*b*(1.-b);}vec2 p(vec2 v,vec2 c,float r){float b=clamp(.5+.5*(c.r-v.r)/r,0.,1.);return mix(c,v,1.-b)+r*b*b;}vec3 z=vec3(1.6-l.a,-c.g*.1,0.);float p(vec3 v){float r=dot(v,v);v=sin(10.*v/r+z);vec4 c=vec4(3.*v.rgb,1.);m=vec4(1.);for(int i=0;i<13;i++){c*=n;c.rgb=clamp(c.rgb,-1.,1.)*2.-c.rgb;float f=dot(c.rgb,c.rgb);if(i<6)m=min(m,abs(vec4(c.rgb,f)));c=c*clamp(max(.6/f,.6),0.,1.)*x+s;}return min((length(c.rgb)-b)/c.a-g,length(v.rb)-.01)*r*.1;}vec2 t(in vec3 r){vec2 i=vec2(length(r)-.9,2.);if(c.b>0.&&length(r)<3.){vec2 f=vec2(80.);for(int b=1;b<6;b++){float m=float(b);vec3 l=sin(vec3(.5*c.r*m,m+c.r/m,4.+.5*c.r*m));l.g+=c.b-3.;f=t(f,vec2(length(r-l)-.5),.8);}f.g=.1;i=t(i,f,.5);}return t(t(vec2(r.y+1.+sin(c.x+3.*(r.x+r.z))*.002,0.),p(vec2(p(r),1.),vec2(1.-length(vec2(length(r.xz)-2.,r.y-.5)),1.),20.*v[0].y),.1),i,.1);}vec3 h(vec3 r){return normalize(vec3(t(r+f.rgb).r-t(r-f.rgb).r,t(r+f.grb).r-t(r-f.gbr).r,t(r+f.gbr).r-t(r-f.gbr).r));}vec3 h(in vec3 v,in vec3 b){float i=0.,c=r*.1;vec2 m=vec2(.1);int l=0;for(int g=0;g<60;g++){if(abs(m.r)<f.r*c||i>80.)continue;m=t(v+b*i);i+=min(2.,.5*m.r);r+=m.r;c+=m.r;l+=1;}if(i>80.)m.g=-1.;return vec3(i,l,m.g);}vec3 h(in vec3 c,in vec3 v,in vec3 r,in vec3 b){vec3 i=vec3(1.)-vec3(0.,1.-m.r,1.)*(m.a*m.a);return mix(i*c.b,vec3(2.),max(0.,c.b-1.))*.5*pow(1.-c.g*(.7/60.),2.);}float p(float v,float r){return step(3.84*v,c.r)*(1.-step(3.84*r,c.r));}void main(){vec2 v=gl_FragCoord.rg/vec2(1280.,720.),f=-1.+2.*v;f.r*=1.77778;float r=c.r,b;vec3 m=p(0.,4.)*(vec3(4.,.5,4.)+vec3(.3,.1,0.)*r),g=p(0.,4.)*vec3(1.,-2.,1.);m+=p(4.,6.)*(vec3(3.,0.,-6.5)+vec3(0.,.2,0.)*(r-15.36));g+=p(4.,6.)*i;m+=p(6.,8.)*(vec3(-9.,1.,1.)+vec3(.5,.1,0.)*(r-23.04));g+=p(6.,8.)*vec3(1.,-.2,0.);l.a=p(16.,22.)*sin(1.00512*(r-61.44))*.05;float s=clamp((r-30.72)/19.2,0.,1.),a=clamp((r-99.84)/23.04,0.,.1),x=smoothstep(0.,.1,(r-92.16)/15.36),z=5.-2.*s+2.*x*x-4.*a*a;m+=p(8.,32.)*(vec3(sin(r*-.1),2.-1.5*s-.4*x+.5*a,cos(r*.2))*z);g+=p(8.,32.)*(vec3(0.,1.-s,0.)-m);g=normalize(g);vec3 n=cross(i.grg,g),y=cross(g,n),t=normalize(g+1.1*(f.r*n+f.g*y)),d,e=h(m,t),o=m+e.r*t;if(e.b>=0.){vec3 u=o-t*.01,w=normalize(h(u)),F=reflect(t,w);d=h(e,o,w,F);b=.8;for(int C=0;C<3;C++){if(e.b<.8){b*=.8-e.b;e=h(u,F);if(e.b>=0.)u=u+e.r*.98*F,w=h(u),F=reflect(F,w),d=d+b*h(e,u,w,F);}}}d=pow(d*2.,vec3(1.5))*sqrt(32.*v.r*v.g*(1.-v.r)*(1.-v.g))*c.a*c.a;gl_FragColor=vec4(d,1.);}
